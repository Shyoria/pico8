pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
 player = entity({
  position = position(64,64),
  control = control(),
  sprite = sprite(1,4,1),
  intention = intention()
 })
end

function _update()
 inputsystem()
 movementsystem()
end

function _draw()
	cls()
	map()
	
	rendersystem()

end
-->8
--ecs

entities = {}

function entity(components)
 local e = {}
 add(entities,e)

 for cname, component in pairs(components) do
  e[cname] = component
 end
 
 return e
end
-->8
--components

function position(x,y) 
	local p={}
	p.x=x
	p.y=y
	
	return p
end

function control(left,right,up,down,a,b)
 local c={}
 c.left=left
 c.right=right
 c.up=up
 c.down=down
 c.a=a
 c.b=b
 
 return c
end

function intention()
 local i={}
 i.left=false
 i.right=false
 i.up=false
 i.down=false
 
 return i
end
function sprite(id,xoffset,yoffset) 
 local s={}
 s.id=id
 s.xoffset=xoffset
 s.yoffset=yoffset
 
 return s
end
-->8
--system
function inputsystem() 
 for e in all(entities) do
  if e.intention ~= nil
   and e.control ~= nil
  then
   e.intention.left = btn(0)
   e.intention.right = btn(1)
   e.intention.up = btn(2)
   e.intention.down = btn(3)
  end
 end
end

function movementsystem()
 for e in all(entities) do
  if e.position ~= nil
   and e.intention ~= nil
  then
   if e.intention.left then e.position.x -= 1 end
   if e.intention.right then e.position.x += 1 end
   if e.intention.up then e.position.y -= 1 end
   if e.intention.down then e.position.y += 1 end
  end
 end
end

function rendersystem()
 for e in all(entities) do
  if e.position ~= nil
   and e.sprite ~= nil
  then
   spr(e.sprite.id,e.position.x,e.position.y)
  end
 end
end

function collisionsystem()
 for e in all(entities) do
  if e.position ~= nil
   and e.circle_collision ~= nil
  then
   -- entity x entity
   
  
   -- entity x map
   if fget(mget(
    e.position.x/8,
    e.position.y/8
    ),1)
   then
   	-- kinda this,
   	-- maybe only apply position
   	-- when movement is allowed
   	-- rather than revert change
   end
  end
 end
end
-->8
--utils

function distance(a,b)
	local dx = b.x-a.x
	local dy = b.y-a.y
	return sqrt(dx*dx+dy*dy)
end

function in_range(value, _min, _max)
 return value >= min(_min,_max)
  and value <= max(_min,_max)
end

function range_intersect(min0,max0,min1,max1)
 return max(min0,max0) >= min(min1,max1)
  and min(min1,max1) >= max(min1,max1)
end

function circle_collision(c0,c1)
 return distance(c0,c1) < c0.radius + c1.radius
end

function circle_point_collision(point, circle)
 return distance(point, circle) < circle.radius
end

function point_rect(point,rec)
 return in_range(point.x, rec.x, rec.y + rec.width)
  and in_range(point.y, rec.y, rec.y + rec.height)
end

function rect_intersect(r0,r1)
 return range_intersect(r0.x, r0.x+r0.width, r1.x, r1.x+r1.width)
  and range_intersect(r0.y, r0.y+r0.height,r1.y, r1.y+r1.height)
end
__gfx__
000000000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000aa00033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000aa00033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000033333333cccccccc555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020203030303030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202030303030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020203030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
