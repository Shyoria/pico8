pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
 player = entity({
  position = position(32,32),
  control = control(),
  sprite = sprite(1,-4,-8),
  intention = intention(),
  movement = movement(),
  collision = collision(
   "circle",
   {r=2}
   )
 })
end

function _update()
 inputsystem()
 movementsystem()
 collisionsystem()
end

function _draw()
	cls()
	map()
	
	rendersystem()
	
	--debug
	for i,str in pairs(debug_str) do
		rectfill(1,i*6,127,(i+1)*6,0)
		print(str,2,1+i*6,11)
	end
	debug_str = {}
end
-->8
--ecs

entities = {}

function entity(components)
 local e = {}
 add(entities,e)

 for cname, component in pairs(components) do
  e[cname] = component
 end
 
 return e
end
-->8
--components

function position(x,y) 
	local p={}
	p.x=x
	p.y=y
	
	return p
end

function movement()
 local m={}
 m.x=0
 m.y=0
 
 return m
end

function control(left,right,up,down,a,b)
 local c={}
 c.left=left
 c.right=right
 c.up=up
 c.down=down
 c.a=a
 c.b=b
 
 return c
end

function intention()
 local i={}
 i.left=false
 i.right=false
 i.up=false
 i.down=false
 
 return i
end

function sprite(id,xoffset,yoffset) 
 local s={}
 s.id=id
 s.xoffset=xoffset
 s.yoffset=yoffset
 
 return s
end

function collision(typ,data)
 local c={}
 c.typ=typ
 
 for i,d in pairs(data) do
  c[i] = d
 end
 
 return c
end
-->8
--system
function inputsystem() 
 for e in all(entities) do
  if e.intention ~= nil
   and e.control ~= nil
  then
   e.intention.left = btn(0)
   e.intention.right = btn(1)
   e.intention.up = btn(2)
   e.intention.down = btn(3)
  end
 end
end

function movementsystem()
 for e in all(entities) do
  if e.movement ~= nil
   and e.intention ~= nil
  then
   if e.intention.left then e.movement.x = -1 end
   if e.intention.right then e.movement.x = 1 end
   if e.intention.up then e.movement.y = -1 end
   if e.intention.down then e.movement.y = 1 end
  end
 end
end

function rendersystem()
 for e in all(entities) do
  if e.position ~= nil
   and e.sprite ~= nil
  then
   spr(
    e.sprite.id,
    e.position.x+e.sprite.xoffset,
    e.position.y+e.sprite.yoffset
   )
  end
 end
end

function collisionsystem()
 for e in all(entities) do
  if e.position ~= nil
   and e.movement ~= nil
   and (e.movement.x ~= 0
    or e.movement.y ~= 0)
   and e.collision ~= nil
   and e.collision.typ == "circle"
  then
   local newx = e.position.x + e.movement.x
   local newy = e.position.y + e.movement.y
   local canmovex = true
   local canmovey = true
   
   e.movement.x = 0
   e.movement.y = 0
   
   -- entity x entity
   
  
   -- entity x map
   -- get 9 closest solid tiles
   for xx=-1,1 do
    for yy=-1,1 do
     local tx = flr(newx/8)+xx
     local ty = flr(e.position.y/8)+yy
     local tilex = fget(mget(tx,ty),0)
     
     if tilex then
      if circle_rect(
       {
        x=newx,
        y=e.position.y,
        r=e.collision.r
       },
       {x=tx*8,y=ty*8,width=8,height=8}
      ) then
       canmovex=false
      end
     end
     
     tx = flr(e.position.x/8)+xx
     ty = flr(newy/8)+yy
     local tiley = fget(mget(tx,ty),0)
     if tiley then
      if circle_rect(
       {x=e.position.x,y=newy,r=e.collision.r},
       {x=tx*8,y=ty*8,width=8,height=8}
      ) then
       canmovey=false
      end
     end
    end
   end
   
   if canmovex then e.position.x = newx end
   if canmovey then e.position.y = newy end
  end
 end
end
-->8
--utils

debug_str={}
function debug(str)
 add(debug_str,str)
end

function solid(x,y)
 return fget(mget(x/8,y/8),1)
end

function distance(a,b)
	local dx = b.x-a.x
	local dy = b.y-a.y
	return sqrt(dx*dx+dy*dy)
end

function in_range(value, _min, _max)
 return value >= min(_min,_max)
  and value <= max(_min,_max)
end

function range_intersect(min0,max0,min1,max1)
 return max(min0,max0) >= min(min1,max1)
  and min(min1,max1) >= max(min1,max1)
end

function circle_collision(c0,c1)
 return distance(c0,c1) < c0.radius + c1.radius
end

function circle_point_collision(point, circle)
 return distance(point, circle) < circle.radius
end

function point_rect(p,r)
 return in_range(p.x, r.x, r.x + r.width)
  and in_range(p.y, r.y, r.y + r.height)
end

function circle_rect(c,r)
 local dx = c.x - max(r.x, min(c.x, r.x + r.width))
 local dy = c.y - max(r.y, min(c.y, r.y + r.height))
 return (dx * dx + dy * dy) < (c.r * c.r)
end

function rect_intersect(r0,r1)
 return range_intersect(r0.x, r0.x+r0.width, r1.x, r1.x+r1.width)
  and range_intersect(r0.y, r0.y+r0.height,r1.y, r1.y+r1.height)
end
__gfx__
000000000000000033333333cccccccc505050500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000003333b3b3cccccccc0505050500cccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000000000033333b33cccccccc505050500c76ccc000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000cccc0033333333cccccccc050505050cccccc000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000c76ccc033333333cccccccc505050500cccc1c000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700ccc11cccbb3b3333cccccccc050505050ccc1cc00c766cc0000000000000000000000000000000000000000000000000000000000000000000000000
00000000cc1111cc33b33333cccccccc5050505000cccc00cc1111cc000000000000000000000000000000000000000000000000000000000000000000000000
000000000cccccc033333333cccccccc05050505000000000ccc1cc0000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020203030303030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202030303030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020203030302020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202030303030202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402020202020202020202020202020400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
